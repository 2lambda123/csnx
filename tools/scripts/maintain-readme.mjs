import { readFile, writeFile } from 'node:fs/promises';
import path from 'node:path'
import { fileURLToPath } from 'node:url';
import updateSection from 'update-section'
import { getPackages } from "@manypkg/get-packages";

const thisFilePath = fileURLToPath(import.meta.url);
const __dirname = path.dirname(thisFilePath);

const projectRoot = path.resolve(__dirname, '..', '..');
const pathFromRoot = (target) => path.relative(projectRoot, target);

const readMePath = path.resolve(projectRoot, 'README.md');

let readme = await readFile(readMePath, 'utf8');

const updateReadmeSection = ({ label, updates }) => {
	const START = `<!-- START ${label} -->`;
	const END = `<!-- END ${label} -->`;

	function matchesStart(line) {
		return line.includes(START);
	}

	function matchesEnd(line) {
		return line.includes(END);
	}

	return updateSection(
		readme,
		[
			START,
			`<!-- THIS LIST IS AUTOGENERATED BY ${pathFromRoot(thisFilePath)} -->`,
			'',
			updates,
			'',
			END,
		].join('\n'),
		matchesStart,
		matchesEnd,
	);
};

const { packages } = await getPackages()
const packageListMarkdown = packages.map(pkg => `- [${pkg.packageJson.name}](${pathFromRoot(pkg.dir)})`).join('\n');

readme = updateReadmeSection({ label: 'PACKAGES', updates: packageListMarkdown })

await writeFile(readMePath, readme);
