#!/usr/bin/env bash

# The Nx convention is to build packages to a root `dist` directory, but
# changesets expects `dist` and `package.json` to live alongside the `src`
# files in the standard workspace.
#
# Therefore, after building the packages we are going to publish, we will
# rewrite the pnpm workspace file to point to the root `dist` directory instead.
#
# This will allow changesets to find the newly built assets to publish.
#
# Once we've published, we will restore the orginal workspace.
#
# It's a slight modification of the method described in:
# https://dev.to/jmcdo29/automating-your-package-deployment-in-an-nx-monorepo-with-changeset-4em8

# n.b. github actions can't write in place, so we use a temp file
echo "Rewriting workspace file to point to dist"
sed -e "s|'libs\/|'dist/|" pnpm-workspace.yaml > pnpm-new.yaml
mv pnpm-new.yaml pnpm-workspace.yaml

# Publish to npm using changesets
corepack pnpm changeset publish

# Rewrite the pnpm workspace file to point to the libs folder.
# This is the default behavior for pnpm/Nx, and undoes the custom setup
# generated by tools/scripts/restore-workspace-for-publishing.
echo "Rewriting workspace file to point to libs"
sed -e "s|'dist\/|'libs/|" pnpm-workspace.yaml > pnpm-new.yaml
mv pnpm-new.yaml pnpm-workspace.yaml
